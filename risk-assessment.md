# Minification Risk Assessment

## Context
This document catalogs occurrences of JavaScript/TypeScript language features that **previously caused a _production-only_ crash** (see `POSTMORTEM_PRODUCTION_CRASH.md`).  The same Metro–minification edge-cases can silently re-appear if we keep shipping these patterns.  The inventory below focuses on **mobile-app code** (bundled by Metro), because that is where the original bug surfaced.  Admin-dashboard / backend occurrences are noted separately but are less urgent.

---
## 1. Patterns Known to Break Under Metro Minifier

| ID | Risk Pattern | Why it Crashes |
|----|--------------|----------------|
| P-1 | `array.filter(Boolean)` | Minifier sometimes converts the implicit Boolean reference into an undefined symbol. |
| P-2 | `Array.from(new Set(array))` | The Set constructor / spread combo was inlined incorrectly, producing `undefined`. |
| P-3 | `array.includes(value)` | Internally rewritten to a helper that was tree-shaken away. |
| P-4 | `array.find(cb)` / `array.some(cb)` | Similar helper-inlining issue as `includes`. |
| P-5 | `Promise.allSettled()` | Polyfill is **not** injected by Metro → undefined at runtime in iOS release builds. |

---
## 2. Mobile-App Risk Inventory  
(Only files that are part of the Expo bundle)

| Pattern | File & Code Reference |
|---------|-----------------------|
| `filter(Boolean)` | ```82:88:src/stores/prayerPeopleStore.ts```, ```39:41:src/components/profile/hooks/usePrayerPeople.ts```, ```26:28:src/hooks/useHomeScreenMinimal.ts```, ```495:497:src/lib/onboarding/recovery-manager.ts``` |
| `Array.from(new Set())` | ```28:30:src/hooks/useHomeScreenMinimal.ts``` |
| `Promise.allSettled()` | ```410:415:src/hooks/useHomeScreen.backup.ts``` *(legacy backup file, currently not imported)* |
| `includes / find / some` | > 150 occurrences across `src/` & `app/` – too many to list; see section 4. |

> **High-Risk = bolded lines above.**  Those are exact recreations of the pattern that brought the app down.

---
## 3. Admin / Backend Code
The same patterns exist in service packages under `services/**`, but those bundles are produced with **Vite / Node** and have not exhibited the minification bug.  Risk is therefore _LOW_, unless shared code ever migrates to mobile.

---
## 4. Quantitative Summary

| Pattern | Mobile Hits | Admin/Server Hits |
|---------|-------------|-------------------|
| `filter(Boolean)` | 4 | 6 |
| `Array.from(new Set())` | 1 | 0 |
| `Promise.allSettled()` | 1 (unused) | 3 |
| `.includes()` | ~180 | ~400 |
| `.find()` / `.some()` | Hundreds | Hundreds |

---
## 5. Recommendations
1. **Immediate Fix** – Rewrite the 4 live mobile occurrences of `filter(Boolean)` to `filter(x => !!x)` and the single `Array.from(new Set())` to a manual dedupe loop.
2. **Quarantine** – Delete or isolate `src/hooks/useHomeScreen.backup.ts` to ensure its `Promise.allSettled()` usage never ships.
3. **Lint Rule** – Add an ESLint rule (or custom plugin) that _errors_ on patterns P-1…P-5 inside `app/**` and `src/**`.
4. **Polyfill Option** – Alternatively, configure Metro's `transformer.minifierConfig` to inject core-js polyfills for ES-2019 array helpers; this increases bundle size but is a one-time fix.
5. **CI Gate** – Run `npx expo run:ios --configuration Release` in CI and fail the job on any `ReferenceError: undefined is not a function` in the JS engine.

---
## 6. How an AI Assistant Should Use This File
* Treat **P-1 … P-5** as _forbidden_ in new mobile code unless a polyfilled / linted workaround is added.
* When refactoring, search for the regexes below and convert to safe alternatives:
  ```
  /\.filter\(Boolean\)/g
  /Array\.from\s*\(\s*new\s+Set\s*\(/g
  /\.includes\(/g
  /\.find\(/g
  /\.some\(/g
  /Promise\.allSettled\(/g
  ```
* Always test changes with a local **Release** build before opening a Pull Request:
  ```bash
  npx expo run:ios --configuration Release | cat
  ```
* If you _must_ use one of the risky methods, wrap it in a dedicated **utility function** that is covered by Jest tests _and_ has a try–catch fallback.

---
## 7. Appendix – Code Citations
Below are direct citations of the highest-risk lines so future tooling can refactor automatically:

```82:88:src/stores/prayerPeopleStore.ts
const activePersonIds = [...new Set(intentionsData?.map(i => i.person_id).filter(Boolean) || [])];
```

```39:41:src/components/profile/hooks/usePrayerPeople.ts
.map(i => i.person_id)
.filter(Boolean) as string[]);
```

```26:30:src/hooks/useHomeScreenMinimal.ts
const mappedIds = intentionsData?.map((i: any) => i.person_id).filter(Boolean) || [];
const stringIds = mappedIds.map((id: any) => `${id}`);
const uniqueIds = Array.from(new Set(stringIds));
```

```410:415:src/hooks/useHomeScreen.backup.ts
const results = await Promise.allSettled(
  tasksToRun.map(ft => {
    ...
  })
);
```

---
**Generated by:** automated code-scan on _June 20 2025_.