<!DOCTYPE html>
<html>
<head>
    <title>Run TikTok Portfolio Migrations</title>
</head>
<body>
    <h1>Running TikTok Portfolio Migrations</h1>
    <div id="output"></div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
        
        // Use viral DB credentials
        const supabaseUrl = 'https://molydcrzwsoeyqkiofwe.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vbHlkY3J6d3NvZXlxa2lvZndlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzM5Mzk5NjMsImV4cCI6MjA0OTUxNTk2M30.9BEFdJDkkgU6aPMmgV1YJ5fMxdntyZzOQl_9CvbEKJg'
        
        const supabase = createClient(supabaseUrl, supabaseKey)
        
        const output = document.getElementById('output')
        
        function log(message) {
            output.innerHTML += message + '<br>'
            console.log(message)
        }
        
        async function runMigrations() {
            log('üöÄ Starting migrations...')
            
            // 1. Add metadata column to tiktok_accounts
            try {
                log('üìù Adding metadata column to tiktok_accounts...')
                const { error: metadataError } = await supabase.rpc('exec_sql', {
                    sql: `
                        ALTER TABLE tiktok_accounts 
                        ADD COLUMN IF NOT EXISTS metadata JSONB DEFAULT '{}';
                        
                        CREATE INDEX IF NOT EXISTS idx_tiktok_accounts_metadata 
                        ON tiktok_accounts USING GIN (metadata);
                    `
                })
                
                if (metadataError) {
                    log('‚ùå Metadata error: ' + metadataError.message)
                } else {
                    log('‚úÖ Metadata column added successfully')
                }
            } catch (e) {
                log('‚ùå Metadata exception: ' + e.message)
            }
            
            // 2. Create tiktok_videos table
            try {
                log('üìù Creating tiktok_videos table...')
                const { error: videosError } = await supabase.rpc('exec_sql', {
                    sql: `
                        CREATE TABLE IF NOT EXISTS tiktok_videos (
                          id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                          account_id UUID REFERENCES tiktok_accounts(id) ON DELETE CASCADE,
                          tiktok_video_id TEXT NOT NULL,
                          caption TEXT,
                          video_url TEXT,
                          cover_url TEXT,
                          duration INTEGER DEFAULT 0,
                          created_at_tiktok TIMESTAMPTZ,
                          stats JSONB DEFAULT '{}',
                          share_url TEXT,
                          created_at TIMESTAMPTZ DEFAULT NOW(),
                          updated_at TIMESTAMPTZ DEFAULT NOW(),
                          
                          UNIQUE(account_id, tiktok_video_id)
                        );
                        
                        CREATE INDEX IF NOT EXISTS idx_tiktok_videos_account_id 
                        ON tiktok_videos(account_id);
                        
                        CREATE INDEX IF NOT EXISTS idx_tiktok_videos_created_at 
                        ON tiktok_videos(created_at_tiktok DESC);
                        
                        ALTER TABLE tiktok_videos ENABLE ROW LEVEL SECURITY;
                        
                        CREATE POLICY IF NOT EXISTS "Allow all operations on tiktok_videos for authenticated users" 
                        ON tiktok_videos FOR ALL USING (true);
                    `
                })
                
                if (videosError) {
                    log('‚ùå Videos table error: ' + videosError.message)
                } else {
                    log('‚úÖ tiktok_videos table created successfully')
                }
            } catch (e) {
                log('‚ùå Videos table exception: ' + e.message)
            }
            
            log('üéâ Migrations completed!')
        }
        
        runMigrations()
    </script>
</body>
</html>